<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Daily Inventory UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/static/favicon.ico">

  <!-- THEME (light + dark) -->
  <style>
    /* Light (default) */
    :root{
      --bg:#ffffff; --card:#ffffff; --border:#e5e7eb;
      --muted:#6b7280; --text:#111827; --accent:#16a34a; --danger:#dc2626;
      --input-bg:#ffffff; --input-border:#cbd5e1; --chip-bg:#f8fafc; --tab-active:#f1f5f9;
    }
    /* Dark */
    :root[data-theme="dark"]{
      --bg:#0f172a; --card:#111827; --border:#1f2937;
      --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444;
      --input-bg:#0b1220; --input-border:#22304a; --chip-bg:#0b1220; --tab-active:#1b2336;
    }

    *{ box-sizing:border-box }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--text); }
    header{ padding:20px; border-bottom:1px solid var(--border); background:var(--card); position:sticky; top:0; z-index:10; }
    h1{ margin:0; font-size:20px; }
    .wrap{ max-width:1100px; margin:0 auto; padding:20px; display:grid; gap:18px; }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04); }

    .row{ display:grid; gap:12px; grid-template-columns:repeat(12,1fr); align-items:end; }
    .col-2{grid-column:span 2}.col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}

    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input,select{ width:100%; padding:10px 12px; background:var(--input-bg); color:var(--text); border:1px solid var(--input-border); border-radius:10px; outline:none; }
    input::placeholder{ color:#9ca3af; }

    button{ padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:var(--card); color:var(--text); cursor:pointer; }
    button:hover{ filter:brightness(0.98); }
    button.primary{ background:linear-gradient(180deg,#22c55e,#16a34a); border-color:#16a34a; color:#ffffff; font-weight:600; }
    button.secondary{ background:var(--card); }
    button.danger{ border-color:#fecaca; background:#fff1f2; color:#991b1b; }
    :root[data-theme="dark"] button.danger{ border-color:#7f1d1d; background:#1f0e10; color:#fca5a5; }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; }
    .status{ font-size:13px; color:var(--muted); }
    .status.ok{ color:var(--accent); }
    .status.err{ color:var(--danger); }

    table{ width:100%; border-collapse:collapse; margin-top:10px; background:var(--card); }
    th,td{ padding:10px; border-bottom:1px solid var(--border); text-align:left; font-size:14px; }
    th{ color:#374151; font-weight:600; background:#f8fafc; }
    :root[data-theme="dark"] th{ color:#9fb0c6; background:#0b1220; }
    tfoot td{ font-weight:700; background:#fafafa; }
    :root[data-theme="dark"] tfoot td{ background:#0b1220; }

    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:var(--chip-bg); font-size:12px; color:#334155; }
    :root[data-theme="dark"] .pill{ color:#c7d2fe; }

    .tabs{ display:flex; gap:8px; }
    .tab{ padding:8px 12px; border:1px solid var(--border); border-radius:999px; cursor:pointer; background:var(--card); }
    .tab.active{ background:var(--tab-active); }

    .hidden{ display:none; }
    .right{ display:flex; gap:10px; align-items:center; }

    @media (max-width:820px){
      .row{ grid-template-columns:1fr; }
      .col-2,.col-3,.col-4,.col-6,.col-8,.col-12{ grid-column:1/-1; }
      table{ font-size:13px; }
      th,td{ padding:8px; }
      .right{ flex-wrap:wrap; justify-content:flex-start; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="padding:0; display:flex; justify-content:space-between; align-items:center;">
      <h1>Daily Inventory</h1>
      <div style="display:flex; gap:8px; align-items:center;">
        <div class="tabs">
          <button class="tab active" id="tabTransactions">Transactions</button>
          <button class="tab" id="tabSummary">Daily Summary</button>
        </div>
        <button id="themeToggle" class="secondary" title="Toggle theme">ðŸŒ“</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Connection / Auth -->
    <section class="card">
      <div class="row">
        <div class="col-6">
          <label>API Base URL <span class="pill">leave empty for same origin</span></label>
          <input id="apiBase" placeholder="e.g. http://127.0.0.1:8000" />
        </div>
        <div class="col-6">
          <label>X-API-Key</label>
          <input id="apiKey" placeholder="your API key" />
        </div>
      </div>
      <div class="controls" style="margin-top:12px">
        <button class="secondary" id="btnPing">Test connection</button>
        <span id="connStatus" class="status">Idle</span>
      </div>
    </section>

    <!-- Add Transaction -->
    <section class="card" id="sectionAdd">
      <h3 style="margin:0 0 12px 0; font-size:16px">Record Transaction</h3>
      <div class="row">
        <div class="col-4">
          <label>Item Name</label>
          <input id="itemName" placeholder="" />
        </div>
        <div class="col-2">
          <label>Purchase Rate (per kg)</label>
          <input id="purchaseRate" type="number" step="0.01" min="0" placeholder="8.50" />
        </div>
        <div class="col-2">
          <label>Sale Rate (per kg)</label>
          <input id="saleRate" type="number" step="0.01" min="0" placeholder="12.00" />
        </div>
        <div class="col-2">
          <label>Quantity (kg)</label>
          <input id="quantityKg" type="number" step="0.001" min="0" placeholder="50.000" />
        </div>
        <div class="col-2">
          <label>Transaction Date (optional)</label>
          <input id="txDate" type="date" />
        </div>
      </div>
      <div class="controls" style="margin-top:10px">
        <button class="primary" id="btnAdd">Add</button>
        <span class="status" id="addStatus">Waitingâ€¦</span>
      </div>
    </section>

    <!-- Transactions: Filters + Table + Pagination -->
    <section class="card" id="sectionTransactions">
      <div class="row">
        <div class="col-3">
          <label>Filter: Item</label>
          <select id="filterItem">
            <option value="">All items</option>
          </select>
        </div>
        <div class="col-3">
          <label>Date From</label>
          <input id="filterFrom" type="date" />
        </div>
        <div class="col-3">
          <label>Date To</label>
          <input id="filterTo" type="date" />
        </div>
        <div class="col-3">
          <label>Page Size</label>
          <select id="pageLimit">
            <option>10</option>
            <option selected>20</option>
            <option>50</option>
            <option>100</option>
          </select>
        </div>
      </div>
      <div class="controls" style="justify-content:space-between; align-items:center; margin-top:10px">
        <div class="right">
          <button class="secondary" id="btnApply">Apply Filters</button>
          <button class="secondary" id="btnClear">Clear</button>
          <button class="secondary" id="btnRefresh">Refresh</button>
          <button class="secondary" id="btnTxCSV">Download CSV</button>
        </div>
        <div class="right">
          <button class="secondary" id="btnPrev">Prev</button>
          <span id="pageInfo" class="status">Page 1</span>
          <button class="secondary" id="btnNext">Next</button>
        </div>
      </div>
      <div class="status" id="listStatus" style="margin:10px 0">No data loaded yet.</div>
      <div style="overflow:auto">
        <table id="txTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Date</th>
              <th>Item</th>
              <th>Purchase</th>
              <th>Sale</th>
              <th>Qty (kg)</th>
              <th>Profit (row)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="5">Totals (this page)</td>
              <td id="totQty">0</td>
              <td id="totProfit">0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- Daily Summary -->
    <section class="card hidden" id="sectionSummary">
      <div class="row">
        <div class="col-4">
          <label>Item (optional)</label>
          <select id="sumItem">
            <option value="">All items</option>
          </select>
        </div>
        <div class="col-4">
          <label>Date From</label>
          <input id="sumFrom" type="date" />
        </div>
        <div class="col-4">
          <label>Date To</label>
          <input id="sumTo" type="date" />
        </div>
      </div>
      <div class="controls" style="margin-top:10px; justify-content:space-between">
        <div>
          <button class="secondary" id="btnLoadSummary">Load Summary</button>
          <span id="sumStatus" class="status">Waitingâ€¦</span>
        </div>
        <button class="secondary" id="btnSumCSV">Download CSV</button>
      </div>
      <div style="overflow:auto; margin-top:10px">
        <table id="sumTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Total Qty (kg)</th>
              <th>Total Profit</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // --- Theme toggle (persisted, system default) ---
    const THEME_KEY = "inventory_theme";
    function prefersDark(){ return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches; }
    function applyTheme(theme){
      if(theme === "dark"){ document.documentElement.setAttribute("data-theme","dark"); }
      else{ document.documentElement.removeAttribute("data-theme"); }
      localStorage.setItem(THEME_KEY, theme);
      const btn = document.getElementById("themeToggle");
      if(btn) btn.textContent = theme === "dark" ? "ðŸŒž" : "ðŸŒ“";
    }
    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      const initial = saved || (prefersDark() ? "dark" : "light");
      applyTheme(initial);
      const btn = document.getElementById("themeToggle");
      if(btn){
        btn.addEventListener("click", () => {
          const cur = document.documentElement.getAttribute("data-theme") === "dark" ? "dark" : "light";
          applyTheme(cur === "dark" ? "light" : "dark");
        });
      }
      if(!saved && window.matchMedia){
        window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", e => applyTheme(e.matches ? "dark" : "light"));
      }
    }
    initTheme();

    // --- UI helpers ---
    const $ = (id) => document.getElementById(id);
    const qs = (sel) => document.querySelector(sel);

    // Tabs
    const tabTx = $("tabTransactions");
    const tabSum = $("tabSummary");
    const sectionTx = $("sectionTransactions");
    const sectionAdd = $("sectionAdd");
    const sectionSum = $("sectionSummary");
    tabTx.addEventListener("click", () => {
      tabTx.classList.add("active"); tabSum.classList.remove("active");
      sectionTx.classList.remove("hidden"); sectionAdd.classList.remove("hidden");
      sectionSum.classList.add("hidden");
    });
    tabSum.addEventListener("click", () => {
      tabSum.classList.add("active"); tabTx.classList.remove("active");
      sectionSum.classList.remove("hidden");
      sectionTx.classList.add("hidden"); sectionAdd.classList.add("hidden");
    });

    // API helpers
    function apiBase(){ const v = $("apiBase").value.trim(); return v || ""; }
    function headers(auth=true){ const base = { "Content-Type": "application/json" }; if(!auth) return base; const key = $("apiKey").value.trim(); return key ? { ...base, "X-API-Key": key } : base; }
    function fmt(n, digits=2){ const x = Number(n); if(Number.isNaN(x)) return "0"; return x.toLocaleString(undefined, { minimumFractionDigits: digits, maximumFractionDigits: digits }); }

    // CSV helpers
    function toCSV(rows, headers){
      const esc = (v) => { const s = String(v ?? ""); return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; };
      const head = headers.map(esc).join(",");
      const body = rows.map(r => headers.map(h => esc(r[h])).join(",")).join("\n");
      return head + "\n" + body;
    }
    function downloadCSV(filename, csvString){
      const blob = new Blob([csvString], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // Items (for dropdowns)
    async function loadItems(){
      try{
        const resp = await fetch(apiBase() + "/items");
        const data = await resp.json();
        const items = data.items || [];
        for(const sel of [ $("filterItem"), $("sumItem") ]){
          const cur = sel.value;
          sel.innerHTML = `<option value="">All items</option>` + items.map(i => `<option value="${i}">${i}</option>`).join("");
          if([...sel.options].some(o => o.value === cur)) sel.value = cur;
        }
      }catch{}
    }

    // Connection test
    $("btnPing").addEventListener("click", async () => {
      const s = $("connStatus"); s.textContent = "Testingâ€¦"; s.className = "status";
      try{
        const resp = await fetch(apiBase() + "/transactions", { headers: headers(false) });
        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        s.textContent = `OK â€¢ ${data.total_records} records`; s.className = "status ok";
        await loadItems();
      }catch(e){
        s.textContent = "Connection failed: " + (e.message || e); s.className = "status err";
      }
    });

    // Add transaction
    $("btnAdd").addEventListener("click", async () => {
      const s = $("addStatus"); s.textContent = "Submittingâ€¦"; s.className = "status";
      const item_name = $("itemName").value.trim();
      const purchase_rate = parseFloat($("purchaseRate").value);
      const sale_rate = parseFloat($("saleRate").value);
      const quantity_kg = parseFloat($("quantityKg").value);
      const transaction_date = $("txDate").value ? $("txDate").value : undefined;

      if(!item_name || !(purchase_rate>0) || !(sale_rate>0) || !(quantity_kg>0)){
        s.textContent = "Please fill all fields with valid values."; s.className = "status err"; return;
      }
      try{
        const body = { item_name, purchase_rate, sale_rate, quantity_kg };
        if(transaction_date) body.transaction_date = transaction_date;
        const resp = await fetch(apiBase() + "/transactions", {
          method: "POST", headers: headers(true), body: JSON.stringify(body)
        });
        const data = await resp.json();
        if(!resp.ok) throw new Error(data?.detail || resp.statusText);
        s.textContent = `Saved: ${data.item_name} â€¢ ${data.quantity_kg} kg â€¢ Profit ${fmt(data.total_profit)}`; s.className = "status ok";
        $("itemName").value = ""; $("purchaseRate").value = ""; $("saleRate").value = ""; $("quantityKg").value = ""; $("txDate").value = "";
        await loadTransactions(true); await loadItems();
      }catch(e){
        s.textContent = "Error: " + (e.message || e); s.className = "status err";
      }
    });

    // Transactions + pagination
    let loading = false; let offset = 0; let lastTxRows = [];
    $("btnApply").addEventListener("click", () => { offset = 0; loadTransactions(true); });
    $("btnClear").addEventListener("click", () => { $("filterItem").value=""; $("filterFrom").value=""; $("filterTo").value=""; offset=0; loadTransactions(true); });
    $("btnRefresh").addEventListener("click", () => loadTransactions(true));
    $("btnPrev").addEventListener("click", () => { const lim = parseInt($("pageLimit").value); offset = Math.max(0, offset - lim); loadTransactions(true); });
    $("btnNext").addEventListener("click", () => { const lim = parseInt($("pageLimit").value); offset += lim; loadTransactions(true); });

    async function loadTransactions(showStatus=false){
      if(loading) return; loading = true;
      const listStatus = $("listStatus");
      if(showStatus){ listStatus.textContent = "Loadingâ€¦"; listStatus.className = "status"; }
      try{
        const params = new URLSearchParams();
        const item = $("filterItem").value, from = $("filterFrom").value, to = $("filterTo").value;
        const limit = parseInt($("pageLimit").value);
        if(item) params.set("item_name", item);
        if(from) params.set("date_from", from);
        if(to) params.set("date_to", to);
        params.set("limit", String(limit)); params.set("offset", String(offset));

        const resp = await fetch(apiBase() + "/transactions?" + params.toString(), { headers: headers(false) });
        const data = await resp.json();
        if(!resp.ok) throw new Error(data?.detail || resp.statusText);

        lastTxRows = data.transactions || [];
        renderTxTable(lastTxRows);
        const total = data.total_records || 0;
        const page = Math.floor(offset / limit) + 1;
        const maxPage = Math.max(1, Math.ceil(total / limit));
        $("pageInfo").textContent = `Page ${page} of ${maxPage} â€¢ ${total} total`;
        if(offset >= total && total > 0){ offset = Math.max(0, (maxPage - 1) * limit); }
        if(showStatus){ listStatus.textContent = `Loaded ${lastTxRows.length} record(s).`; listStatus.className = "status ok"; }
      }catch(e){
        if(showStatus){ listStatus.textContent = "Load failed: " + (e.message || e); listStatus.className = "status err"; }
      }finally{ loading = false; }
    }

    function renderTxTable(rows){
      const tbody = $("txTable").querySelector("tbody"); tbody.innerHTML = "";
      let totQty = 0, totProfit = 0;
      for(const r of rows){
        const unit = Number(r.sale_rate) - Number(r.purchase_rate);
        const profit = unit * Number(r.quantity_kg);
        totQty += Number(r.quantity_kg); totProfit += profit;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.transaction_date}</td>
          <td>${r.item_name}</td>
          <td>${fmt(r.purchase_rate)}</td>
          <td>${fmt(r.sale_rate)}</td>
          <td>${fmt(r.quantity_kg, 3)}</td>
          <td>${fmt(profit)}</td>
          <td><button class="danger" data-del="${r.id}">Delete</button></td>
        `;
        tbody.appendChild(tr);
      }
      $("totQty").textContent = fmt(totQty, 3);
      $("totProfit").textContent = fmt(totProfit);

      // delete handlers
      tbody.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-del");
          const key = $("apiKey").value.trim();
          if(!key){ alert("Enter API key to delete."); return; }
          if(!confirm(`Delete transaction #${id}?`)) return;
          btn.disabled = true;
          try{
            const resp = await fetch(apiBase() + `/transactions/${id}`, { method: "DELETE", headers: headers(true) });
            const data = await resp.json().catch(()=> ({}));
            if(!resp.ok) throw new Error(data?.detail || resp.statusText);
            await loadTransactions(true);
          }catch(e){ alert("Delete failed: " + (e.message || e)); }
          finally{ btn.disabled = false; }
        });
      });
    }

    // TX CSV (current page)
    $("btnTxCSV").addEventListener("click", () => {
      const rows = (lastTxRows || []).map(r => ({
        id: r.id,
        transaction_date: r.transaction_date,
        item_name: r.item_name,
        purchase_rate: r.purchase_rate,
        sale_rate: r.sale_rate,
        quantity_kg: r.quantity_kg,
        profit: (Number(r.sale_rate) - Number(r.purchase_rate)) * Number(r.quantity_kg)
      }));
      const csv = toCSV(rows, ["id","transaction_date","item_name","purchase_rate","sale_rate","quantity_kg","profit"]);
      downloadCSV(`transactions_page.csv`, csv);
    });

    // Summary
    $("btnLoadSummary").addEventListener("click", loadSummary);
    let lastSumRows = [];
    async function loadSummary(){
      const s = $("sumStatus"); s.textContent = "Loadingâ€¦"; s.className = "status";
      try{
        const params = new URLSearchParams();
        const item = $("sumItem").value, from = $("sumFrom").value, to = $("sumTo").value;
        if(item) params.set("item_name", item);
        if(from) params.set("date_from", from);
        if(to) params.set("date_to", to);
        const resp = await fetch(apiBase() + "/summary/daily?" + params.toString(), { headers: headers(false) });
        const data = await resp.json();
        if(!resp.ok) throw new Error(data?.detail || resp.statusText);
        lastSumRows = data.rows || [];
        const tbody = $("sumTable").querySelector("tbody"); tbody.innerHTML = "";
        for(const row of lastSumRows){
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${row.transaction_date}</td><td>${fmt(row.total_qty_kg,3)}</td><td>${fmt(row.total_profit)}</td>`;
          tbody.appendChild(tr);
        }
        s.textContent = `Loaded ${lastSumRows.length} day(s).`; s.className = "status ok";
      }catch(e){ s.textContent = "Load failed: " + (e.message || e); s.className = "status err"; }
    }

    // Summary CSV
    $("btnSumCSV").addEventListener("click", () => {
      const csv = toCSV(lastSumRows || [], ["transaction_date","total_qty_kg","total_profit"]);
      downloadCSV("daily_summary.csv", csv);
    });

    // Boot
    window.addEventListener("load", async () => {
      await Promise.all([loadItems(), loadTransactions(false)]);
    });
  </script>
</body>
</html>
