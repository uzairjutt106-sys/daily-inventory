<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Scrapit â€” Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b1020; --panel:#111733; --muted:#8aa0ff; --text:#e8ecff; --red:#e5484d; --green:#2bb673; --yellow:#e6b800; }
    *{box-sizing:border-box;}
    body{margin:0;background:linear-gradient(135deg,#0a0f2a 0%,#0d1233 100%);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:var(--text);}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px;}
    .status{padding:8px 12px;border-radius:10px;margin-bottom:10px;font-weight:600;display:inline-block}
    .ok{background:#14351e;color:#7ff7b0;border:1px solid #256c3f}
    .bad{background:#3b1424;color:#ffafc2;border:1px solid #8a2d49}
    h1{font-size:28px;margin:6px 0 18px 0;text-align:center}
    h2{font-size:20px;margin:0 0 10px 0;color:var(--muted)}
    .card{background:rgba(17,23,51,.7);border:1px solid rgba(138,160,255,.15);backdrop-filter:blur(8px);padding:14px;border-radius:14px;margin:14px 0;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .grid{display:grid;gap:10px}
    .g2{grid-template-columns:repeat(2,1fr)}
    .g4{grid-template-columns:repeat(4,1fr)}
    .g5{grid-template-columns:repeat(5,1fr)}
    .g6{grid-template-columns:repeat(6,1fr)}
    @media (max-width:880px){.g6,.g5,.g4{grid-template-columns:repeat(2,1fr)}}
    input,button,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(138,160,255,.25);background:#0f1530;color:var(--text);outline:none}
    input[type="number"]{appearance:textfield}
    input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{appearance:none;margin:0}
    button{cursor:pointer;font-weight:600}
    .btn-primary{background:#2a4bff;border-color:#5168ff}
    .btn-warn{background:var(--yellow);border-color:#e0c44d;color:#101222}
    .btn-danger{background:#b3261e;border-color:#e5484d}
    .btn-ok{background:#256c3f;border-color:#2bb673}
    table{width:100%;border-collapse:collapse;background:#0f1430;border:1px solid rgba(138,160,255,.15);border-radius:14px;overflow:hidden}
    thead{background:#151a3b}
    th,td{padding:10px 12px;text-align:left;border-top:1px solid rgba(138,160,255,.08)}
    .right{text-align:right}
    .muted{color:#9fb0ff}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(138,160,255,.28);background:#0e1535}
    .flex{display:flex;gap:10px;align-items:center}
    .space{height:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="conn" class="status pill">checking APIâ€¦</div>
    <h1>ðŸ“¦ Scrapit</h1>

    <!-- Add Purchase -->
    <div class="card">
      <h2>Add Purchase</h2>
      <form id="form-add">
        <div class="grid g6">
          <input id="add-item" list="items-list" placeholder="Item name" required />
          <input id="add-rate" type="number" inputmode="numeric" step="1" min="1" placeholder="Purchase rate (int)" required />
          <input id="add-qty" type="number" inputmode="decimal" step="0.01" min="0.01" placeholder="Quantity (kg)" required />
          <input id="add-date" type="date" />
          <button class="btn-primary" type="submit">Add</button>
          <button id="btn-reset" type="button">Reset</button>
        </div>
      </form>
      <datalist id="items-list"></datalist>
    </div>

    <!-- Filter -->
    <div class="card">
      <h2>Filter Purchases</h2>
      <div class="grid g4">
        <input id="f-item" placeholder="Filter by item" />
        <input id="f-from" type="date" />
        <input id="f-to" type="date" />
        <button id="btn-refetch">Refetch</button>
      </div>
    </div>

    <!-- Transactions table -->
    <div class="card">
      <h2>Purchases</h2>
      <div class="space"></div>
      <table id="tx-table">
        <thead>
          <tr>
            <th>Item</th>
            <th>Purchase Rate</th>
            <th>Quantity (kg)</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="tx-body"></tbody>
      </table>
      <div class="flex" style="justify-content:flex-end;margin-top:10px;">
        <div class="pill">Total Purchase: <span id="tx-total" class="muted" style="margin-left:6px">0.00</span></div>
      </div>
    </div>

    <!-- Daily Purchase Summary -->
    <div class="card">
      <h2>ðŸ“… Daily Purchase Summary</h2>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Total Qty (kg)</th>
            <th>Total Purchase Amount</th>
          </tr>
        </thead>
        <tbody id="daily-body"></tbody>
      </table>
    </div>

    <!-- Sales -->
    <div class="card">
      <h2>ðŸ’° Sales & Profit (Stored)</h2>
      <form id="form-sale">
        <div class="grid g6">
          <input id="sale-item" placeholder="Item name" required />
          <input id="sale-rate" type="number" inputmode="numeric" step="1" min="1" placeholder="Sale rate (int)" required />
          <input id="sale-qty" type="number" inputmode="decimal" step="0.01" min="0.01" placeholder="Quantity (kg)" required />
          <input id="sale-date" type="date" />
          <button class="btn-ok" type="submit">Add Sale</button>
          <div class="pill">Avg purchase: <span id="avg-hint" class="muted" style="margin-left:6px">0.00</span></div>
        </div>
      </form>

      <div class="space"></div>
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th>Avg Purchase Rate</th>
            <th>Sale Rate</th>
            <th>Qty (kg)</th>
            <th>Profit</th>
            <th>Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="sales-body"></tbody>
      </table>
      <div class="flex" style="justify-content:flex-end;margin-top:10px;">
        <div class="pill">Sales Total Profit: <span id="sales-total" class="muted" style="margin-left:6px">0.00</span></div>
      </div>
    </div>
  </div>

  <script>
    // ---- Config ----
    const API = 'http://127.0.0.1:8000';
    const API_KEY = '@uzair143';
    const today = () => new Date().toISOString().slice(0,10);

    // ---- Elements ----
    const connEl = document.getElementById('conn');

    const addItem = document.getElementById('add-item');
    const addRate = document.getElementById('add-rate');
    const addQty  = document.getElementById('add-qty');
    const addDate = document.getElementById('add-date');
    const addForm = document.getElementById('form-add');
    const btnReset = document.getElementById('btn-reset');

    const txBody = document.getElementById('tx-body');
    const txTotal = document.getElementById('tx-total');

    const fItem = document.getElementById('f-item');
    const fFrom = document.getElementById('f-from');
    const fTo   = document.getElementById('f-to');
    const btnRefetch = document.getElementById('btn-refetch');

    const dailyBody = document.getElementById('daily-body');

    const saleItem = document.getElementById('sale-item');
    const saleRate = document.getElementById('sale-rate');
    const saleQty  = document.getElementById('sale-qty');
    const saleDate = document.getElementById('sale-date');
    const saleForm = document.getElementById('form-sale');
    const avgHint  = document.getElementById('avg-hint');

    const salesBody = document.getElementById('sales-body');
    const salesTotal = document.getElementById('sales-total');

    const itemsDatalist = document.getElementById('items-list');

    // ---- State ----
    let transactions = [];
    let sales = [];
    let editingId = null; // transaction id currently being edited

    // ---- Helpers ----
    function setConn(ok){
      connEl.textContent = ok ? 'ðŸŸ¢ API Connected' : 'ðŸ”´ API Disconnected';
      connEl.className = 'status pill ' + (ok ? 'ok' : 'bad');
    }

    function intOnly(value) {
      const v = String(value).replace(/\D+/g,'');
      return v ? String(parseInt(v,10)) : '';
    }

    function money(n){ return (Math.round(n*100)/100).toFixed(2); }

    function filteredTransactions() {
      return transactions.filter(t => {
        const d = new Date(t.transaction_date);
        const matchItem = !fItem.value || t.item_name.toLowerCase().includes(fItem.value.toLowerCase());
        const matchFrom = !fFrom.value || d >= new Date(fFrom.value);
        const matchTo   = !fTo.value   || d <= new Date(fTo.value);
        return matchItem && matchFrom && matchTo;
      });
    }

    function avgPurchaseByItem() {
      const agg = new Map();
      for (const t of transactions) {
        if (t.purchase_rate == null) continue;
        const key = t.item_name.trim().toLowerCase();
        const cur = agg.get(key) || { qty:0, cost:0 };
        cur.qty  += Number(t.quantity_kg);
        cur.cost += Math.trunc(Number(t.purchase_rate)) * Number(t.quantity_kg);
        agg.set(key, cur);
      }
      const out = new Map();
      for (const [k,v] of agg.entries()){
        out.set(k, v.qty>0 ? v.cost/v.qty : 0);
      }
      return out;
    }

    function getAvg(item){
      const m = avgPurchaseByItem();
      return m.get(item.trim().toLowerCase()) || 0;
    }

    // ---- Fetchers ----
    async function loadItems() {
      try {
        const r = await fetch(`${API}/items`, { cache:'no-store' });
        const d = await r.json();
        itemsDatalist.innerHTML = (d.items || []).map(it => `<option value="${it}"></option>`).join('');
      } catch {}
    }

    async function loadTransactions() {
      try {
        const r = await fetch(`${API}/transactions`, { cache:'no-store' });
        const d = await r.json();
        transactions = d.transactions || [];
        setConn(true);
      } catch (e) {
        setConn(false);
      }
      renderTransactions();
      renderDaily();
      loadItems();
      // refresh avg hint if user typed an item
      if (saleItem.value.trim()) avgHint.textContent = money(getAvg(saleItem.value));
    }

    async function loadSales() {
      try {
        const r = await fetch(`${API}/sales`, { cache:'no-store' });
        const d = await r.json();
        sales = d.sales || [];
      } catch {}
      renderSales();
    }

    // ---- Renderers ----
    function renderTransactions(){
      const rows = filteredTransactions();
      let total = 0;
      txBody.innerHTML = rows.map(t => {
        const isEditing = editingId === t.id;
        const amount = Math.trunc(t.purchase_rate || 0) * Number(t.quantity_kg);
        total += amount;

        return `<tr>
          <td>${isEditing ? `<input data-k="item" value="${t.item_name}" />` : t.item_name}</td>
          <td>${isEditing ? `<input data-k="rate" type="number" step="1" min="1" value="${Math.trunc(t.purchase_rate || 0)}" />` : Math.trunc(t.purchase_rate || 0)}</td>
          <td>${isEditing ? `<input data-k="qty" type="number" step="0.01" min="0.01" value="${Number(t.quantity_kg).toFixed(2)}" />` : Number(t.quantity_kg).toFixed(2)}</td>
          <td>${money(amount)}</td>
          <td>${isEditing ? `<input data-k="date" type="date" value="${(t.transaction_date||'').split('T')[0]}" />` : (t.transaction_date||'').split('T')[0]}</td>
          <td>
            ${isEditing
              ? `<button class="btn-ok" data-act="save" data-id="${t.id}">Save</button>
                 <button class="btn-warn" data-act="cancel">Cancel</button>`
              : `<button class="btn-warn" data-act="edit" data-id="${t.id}">Edit</button>
                 <button class="btn-danger" data-act="del" data-id="${t.id}">Delete</button>`
            }
          </td>
        </tr>`;
      }).join('');
      txTotal.textContent = money(total);
    }

    function renderDaily(){
      const map = {};
      for (const t of filteredTransactions()){
        const day = (t.transaction_date||'').split('T')[0];
        if (!map[day]) map[day] = {qty:0, amt:0};
        map[day].qty += Number(t.quantity_kg);
        map[day].amt += Math.trunc(t.purchase_rate || 0) * Number(t.quantity_kg);
      }
      const rows = Object.entries(map).sort((a,b)=>a[0]<b[0]?1:-1);
      dailyBody.innerHTML = rows.map(([d,v])=>`
        <tr>
          <td>${d}</td>
          <td>${v.qty.toFixed(2)}</td>
          <td>${money(v.amt)}</td>
        </tr>
      `).join('') || `<tr><td colspan="3" class="muted">No purchases to summarize.</td></tr>`;
    }

    function renderSales(){
      const avgs = avgPurchaseByItem();
      let total = 0;
      salesBody.innerHTML = (sales.length ? sales.map(s=>{
        const avg = avgs.get(s.item_name.trim().toLowerCase()) || 0;
        const profit = (Number(s.sale_rate) - avg) * Number(s.quantity_kg);
        total += profit;
        return `<tr>
          <td>${s.item_name}</td>
          <td>${money(avg)}</td>
          <td>${Math.trunc(Number(s.sale_rate))}</td>
          <td>${Number(s.quantity_kg).toFixed(2)}</td>
          <td style="color:${profit>=0?'#2bb673':'#e5484d'};font-weight:700">${money(profit)}</td>
          <td>${s.sale_date}</td>
          <td><button class="btn-danger" data-sale-del="${s.id}">Delete</button></td>
        </tr>`;
      }).join('') : `<tr><td colspan="7" class="muted">No sales added yet.</td></tr>`);
      salesTotal.textContent = money(total);
    }

    // ---- Events ----
    addDate.value = today();
    saleDate.value = today();

    addForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const item = addItem.value.trim();
      const rate = intOnly(addRate.value);
      const qty  = Number(addQty.value);
      const date = addDate.value || today();
      if (!item) return alert('Item required');
      if (!rate || Number(rate)<=0) return alert('Purchase rate must be a positive integer');
      if (!Number.isFinite(qty) || qty<=0) return alert('Quantity must be > 0');
      try{
        const r = await fetch(`${API}/transactions`, {
          method:'POST',
          headers:{'Content-Type':'application/json','X-API-Key':API_KEY},
          body:JSON.stringify({ item_name:item, purchase_rate:Number(rate), quantity_kg:qty, transaction_date:date })
        });
        if(!r.ok){ throw new Error(await r.text()); }
        addItem.value=''; addRate.value=''; addQty.value=''; addDate.value=today();
        loadTransactions();
      }catch(err){ alert('Failed to add transaction: '+err.message); }
    });

    btnReset.addEventListener('click', ()=>{
      addItem.value=''; addRate.value=''; addQty.value=''; addDate.value=today();
    });

    btnRefetch.addEventListener('click', ()=>{
      fItem.value=''; fFrom.value=''; fTo.value='';
      loadTransactions();
    });

    fItem.addEventListener('input', ()=>{ renderTransactions(); renderDaily(); });
    fFrom.addEventListener('change', ()=>{ renderTransactions(); renderDaily(); });
    fTo.addEventListener('change', ()=>{ renderTransactions(); renderDaily(); });

    // Inline table actions (edit/save/cancel/delete)
    txBody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button');
      if (!btn) return;
      const act = btn.dataset.act;
      if (act === 'edit'){
        editingId = Number(btn.dataset.id);
        renderTransactions();
      } else if (act === 'cancel'){
        editingId = null;
        renderTransactions();
      } else if (act === 'save'){
        const id = Number(btn.dataset.id);
        const row = btn.closest('tr');
        const val = k => row.querySelector(`input[data-k="${k}"]`).value;
        const item = val('item').trim();
        const rate = intOnly(val('rate'));
        const qty  = Number(val('qty'));
        const date = val('date') || today();
        if (!item) return alert('Item required');
        if (!rate || Number(rate)<=0) return alert('Purchase rate must be a positive integer');
        if (!Number.isFinite(qty) || qty<=0) return alert('Quantity must be > 0');
        try {
          const r = await fetch(`${API}/transactions/${id}`, {
            method:'PUT',
            headers:{'Content-Type':'application/json','X-API-Key':API_KEY},
            body:JSON.stringify({
              item_name:item,
              purchase_rate:Number(rate),
              quantity_kg:qty,
              transaction_date:date
            })
          });
          if(!r.ok){ throw new Error(await r.text()); }
          editingId = null;
          await loadTransactions();
        } catch(err){ alert('Update failed: '+err.message); }
      } else if (act === 'del'){
        const id = Number(btn.dataset.id);
        if (!confirm('Delete this transaction?')) return;
        try {
          const r = await fetch(`${API}/transactions/${id}`, {
            method:'DELETE',
            headers:{'X-API-Key':API_KEY}
          });
          if(!r.ok){ throw new Error(await r.text()); }
          loadTransactions();
        } catch(err){ alert('Delete failed: '+err.message); }
      }
    });

    // Sales
    saleItem.addEventListener('input', ()=>{
      avgHint.textContent = money(getAvg(saleItem.value || ''));
    });

    saleForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const item = saleItem.value.trim();
      const rate = intOnly(saleRate.value);
      const qty  = Number(saleQty.value);
      const date = saleDate.value || today();
      if (!item) return alert('Enter item name');
      if (!rate || Number(rate)<=0) return alert('Sale rate must be a positive integer');
      if (!Number.isFinite(qty) || qty<=0) return alert('Quantity must be > 0');
      try{
        const r = await fetch(`${API}/sales`, {
          method:'POST',
          headers:{'Content-Type':'application/json','X-API-Key':API_KEY},
          body:JSON.stringify({ item_name:item, sale_rate:Number(rate), quantity_kg:qty, sale_date:date })
        });
        if(!r.ok){ throw new Error(await r.text()); }
        saleItem.value=''; saleRate.value=''; saleQty.value=''; saleDate.value=today();
        await loadSales();
      }catch(err){ alert('Failed to add sale: '+err.message); }
    });

    salesBody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-sale-del]');
      if (!btn) return;
      const id = Number(btn.dataset.saleDel);
      if (!confirm('Delete this sale entry?')) return;
      try{
        const r = await fetch(`${API}/sales/${id}`, {
          method:'DELETE',
          headers:{'X-API-Key':API_KEY}
        });
        if(!r.ok){ throw new Error(await r.text()); }
        await loadSales();
      }catch(err){ alert('Delete sale failed: '+err.message); }
    });

    // ---- init ----
    (async function init(){
      addDate.value = today();
      saleDate.value = today();
      await loadTransactions();
      await loadSales();
    })();
  </script>
</body>
</html>
